{% extends "base.html" %}

{% block extra_head %}
  <link rel="stylesheet" href="/static/admin/css/base.css">
  <link rel="stylesheet" href="/static/admin/css/forms.css">
  <link rel="stylesheet" href="/static/admin/css/responsive.css">
  <style>
    .offrez-admin-wrap { max-width: 980px; margin: 0 auto; }
    .offrez-admin-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 16px; }
    .thumb { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e5e5; }
  </style>
{% endblock %}

{% block content %}
<div class="offrez-admin-wrap">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">Edit property</h2>
    <a class="button" href="{% url 'dashboard-my-properties' %}">Back</a>
  </div>

  <div class="offrez-admin-card">
    <form method="post" enctype="multipart/form-data" class="aligned">
      {% csrf_token %}
      <fieldset class="module aligned">
        {{ form.non_field_errors }}
        {# Listing type first #}
        <div class="form-row" data-field="property_type" data-group="always">
          <div>
            {{ form.property_type.errors }}
            <label for="{{ form.property_type.id_for_label }}">{{ form.property_type.label }}</label>
            {{ form.property_type }}
            {% if form.property_type.help_text %}<div class="help">{{ form.property_type.help_text }}</div>{% endif %}
          </div>
        </div>

        {% for field in form %}
          {% if field.name != 'property_type' %}
            <div class="form-row" data-field="{{ field.name }}" data-group="common">
              <div>
                {{ field.errors }}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}<div class="help">{{ field.help_text }}</div>{% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <div class="form-row">
          <div>
            <label>Upload new images</label>
            <input type="file" name="images" multiple>
            <div class="help">New images are appended to the listing.</div>
          </div>
        </div>

        {% if property.images.all %}
          <div class="form-row">
            <div>
              <label>Existing images</label>
              <div class="help">Tick images to remove them.</div>
              <div class="d-flex flex-wrap gap-3">
                {% for img in property.images.all %}
                  <label class="d-flex flex-column gap-2" style="width: 140px;">
                    <img class="thumb" src="{{ img.image.url }}" alt="">
                    <span>
                      <input type="checkbox" name="delete_image" value="{{ img.id }}"> remove
                    </span>
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      </fieldset>

      <div class="submit-row">
        <input type="submit" value="Save changes" class="default">
      </div>

      <p class="help">Any edit will set the listing back to “pending approval”.</p>
    </form>
  </div>
</div>

<script>
  (function () {
    const typeEl = document.getElementById('id_property_type');
    if (!typeEl) return;

    const groupForField = {
      university: 'students',
      gender: 'students',
      overnight: 'students',
      sharing: 'students',
      nightly_price: 'students',
      price_per_month: 'students',
      max_occupancy: 'students',
      distance_to_campus_km: 'students',
      caretaker_number: 'students',

      square_meters: 'real_estate',
      bedrooms: 'real_estate',
      bathrooms: 'real_estate',

      rating_stars: 'resort',
      all_inclusive: 'resort',

      shop_category: 'shop',
    };

    const alwaysCommon = new Set([
      'title',
      'description',
      'city',
      'is_available',
      'location',
      'latitude',
      'longitude',
      'contact_phone',
      'house_number',
      'amenities',
    ]);

    function setRowVisibility(row, visible) {
      row.style.display = visible ? '' : 'none';
    }

    function updateGroups() {
      const selected = (typeEl.value || '').trim();
      const hasType = !!selected;

      document.querySelectorAll('[data-field]').forEach((row) => {
        const fieldName = row.getAttribute('data-field');
        if (fieldName === 'property_type') return;

        if (!hasType) {
          setRowVisibility(row, false);
          return;
        }

        if (alwaysCommon.has(fieldName)) {
          setRowVisibility(row, true);
          return;
        }

        const group = groupForField[fieldName];
        setRowVisibility(row, group ? group === selected : false);
      });
    }

    typeEl.addEventListener('change', updateGroups);
    updateGroups();
  })();
</script>
{% endblock %}
