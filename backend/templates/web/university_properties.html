{% extends "base.html" %}

{% block content %}
<style>
/* University Selector Banner - Minimal, No Background */
.university-selector-banner {
  position: fixed;
  top: 75px;
  right: 15px;
  background: transparent;
  padding: 6px 12px;
  z-index: 1040;
  cursor: pointer;
  transition: none;
  max-width: 200px;
}

.university-selector-banner .current-uni {
  font-weight: 400;
  color: #333;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.university-dropdown {
  position: fixed;
  top: 110px;
  right: 15px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 1039;
  max-width: 250px;
  max-height: 350px;
  overflow-y: auto;
  display: none;
}

.university-dropdown.show {
  display: block;
}

.university-dropdown::-webkit-scrollbar {
  width: 4px;
}

.university-dropdown::-webkit-scrollbar-track {
  background: #f5f5f5;
}

.university-dropdown::-webkit-scrollbar-thumb {
  
}

.university-dropdown-item {
  padding: 10px 16px;
  cursor: pointer;
  transition: background 0.2s ease;
  text-decoration: none;
  color: #333;
  display: block;
  font-size: 13px;
}

.university-dropdown-item:last-child {
  border-bottom: none;
}

.university-dropdown-item:hover {
  background: #f8f9fa;
}

.university-dropdown-item.active {
  background: #ffd700;
  font-weight: 600;
  color: #000;
}

@media (max-width: 576px) {
  .university-selector-banner {
    top: 15px;
    left: 50%;
    right: auto;
    transform: translateX(-50%);
    padding: 4px 10px;
    max-width: 180px;
    z-index: 1100;
  }
  
  .university-selector-banner .current-uni {
    font-size: 11px;
    text-align: center;
  }
  
  .university-dropdown {
    top: 50px;
    left: 50%;
    right: auto;
    transform: translateX(-50%);
    max-width: 220px;
  }
}

/* Fixed Search Bar - Minimal, No Background */
.search-bar {
  position: fixed;
  top: 75px;
  left: 50%;
  transform: translateX(-50%);
  max-width: 600px;
  width: 90%;
  background: transparent;
  padding: 0;
  z-index: 999;
}

@media (max-width: 576px) {
  .search-bar {
    top: 70px;
    max-width: 90%;
  }
}

.search-input {
  border-radius: 25px;
  padding: 8px 16px;
  font-size: 14px;
  border: 1px solid #ddd;
  background: #fafafa;
  transition: all 0.2s ease;
  box-shadow: none;
}

.search-input:focus {
  border-color: #0d6efd;
  box-shadow: 0 2px 8px rgba(13,110,253,0.1);
  outline: none;
  background: #fff;
}

.search-btn {
  border-radius: 25px;
  padding: 8px 20px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  background: #0d6efd;
  transition: all 0.2s ease;
  box-shadow: none;
}

.search-btn:hover {
  background: #0b5ed7;
}

/* Fixed Bottom Filter Panel */
.filter-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: clamp(60px, 10vh, 80px);
  background: linear-gradient(to top, #fff 0%, #fafafa 100%);
  border-top: 2px solid #e8e8e8;
  display: flex;
  align-items: center;
  justify-content: space-evenly;
  padding: 0 clamp(8px, 2vw, 20px);
  gap: clamp(6px, 1.5vw, 12px);
  z-index: 999;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
}

@media (max-width: 576px) {
  .filter-panel {
    justify-content: flex-start;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
  }

  .filter-panel::-webkit-scrollbar {
    height: 0;
  }

  .filter-btn {
    flex: 0 0 auto;
  }
}

.filter-btn {
  flex: 1 1 auto;
  min-width: clamp(60px, 10vw + 2vh, 110px);
  padding: clamp(6px, 1.5vh + 0.3vw, 12px) clamp(6px, 1.5vw + 0.3vh, 16px);
  border: 2px solid #e0e0e0;
  border-radius: 50px;
  background: #fff;
  font-size: clamp(10px, 1.4vw + 0.3vh, 14px);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.04);
}

.filter-btn.active {
  background: #ffd700;
  color: #000;
  border-color: #ffd700;
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
}

.filter-btn:hover:not(.active) {
  border-color: #ffd700;
  background: #fff8dc;
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

/* Content wrapper with padding for fixed elements */
.content-wrapper {
  padding-top: calc(10vh + 80px);
  padding-bottom: calc(10vh + 30px);
  padding-left: clamp(8px, 4vw, 40px);
  padding-right: clamp(8px, 4vw, 40px);
}

@media (max-width: 576px) {
  .content-wrapper {
    padding-left: 2.5vw;
    padding-right: 2.5vw;
  }
}

/* Responsive font sizes - ALL text scales with viewport */
body {
  font-size: clamp(13px, 1.8vw + 0.5vh, 16px);
  background: #fafafa;
  line-height: 1.5;
}

h2 {
  font-size: clamp(20px, 3.5vw + 1vh, 36px);
  font-weight: 700;
  margin-bottom: clamp(16px, 3vh, 30px);
  color: #1a1a1a;
  letter-spacing: -0.5px;
}

h5 {
  font-size: clamp(14px, 2.2vw + 0.5vh, 20px);
  font-weight: 700;
  color: #2a2a2a;
  line-height: 1.3;
}

.card-text {
  font-size: clamp(12px, 1.6vw + 0.4vh, 15px);
  color: #555;
  line-height: 1.6;
}

/* Accommodation cards - inspired by WhatsApp channel tiles */
.properties-grid {
  display: grid;
  gap: clamp(18px, 3vw, 24px);
  grid-template-columns: 1fr;
  margin-bottom: 30px;
}

@media (min-width: 768px) {
  .properties-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1200px) {
  .properties-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

.accommodation-card {
  position: relative;
  border-radius: 22px;
  border: 1px solid #efe6d9;
  background: #fff;
  padding: 14px 16px 16px;
  box-shadow: 0 18px 34px rgba(15, 14, 14, 0.08);
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow: hidden;
}

.accommodation-card::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background-image: radial-gradient(rgba(0,0,0,0.015) 30%, transparent 32%);
  background-size: 16px 16px;
  opacity: 0.7;
}

.accommodation-card > * {
  position: relative;
  z-index: 1;
}

.accommodation-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 22px 42px rgba(15, 14, 14, 0.12);
}

.accommodation-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.accommodation-avatar {
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 2px solid #e0d8c7;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background: #fff9f2;
  flex-shrink: 0;
}

.accommodation-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.accommodation-meta {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.accommodation-channel {
  font-size: 0.95rem;
  font-weight: 700;
  color: #1d1d1f;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.accommodation-followers {
  font-size: 0.78rem;
  color: #8b8b8f;
}

.like-btn {
  margin-left: auto;
  border: none;
  background: #fff;
  color: #ff5a5f;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
}

.like-btn:hover {
  transform: scale(1.1);
}

.like-btn.liked {
  background: #ff5a5f;
  color: #fff;
}

.accommodation-media {
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid #f1ebe2;
  background: linear-gradient(135deg, #f4f1eb 0%, #fff 100%);
  height: clamp(200px, 32vh, 280px);
}

/* Large-screen (desktop) card media redesign */
@media (min-width: 992px) {
  .accommodation-media {
    height: 320px;
  }
}

.accommodation-media-desktop {
  padding: 10px;
}

.media-scroll {
  display: flex;
  gap: 10px;
  height: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}

.media-scroll::-webkit-scrollbar {
  height: 10px;
}

.media-scroll::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.12);
  border-radius: 999px;
}

.media-item {
  flex: 0 0 auto;
  height: 100%;
  width: min(420px, 80%);
  border-radius: 14px;
  overflow: hidden;
  scroll-snap-align: start;
  border: 1px solid #f1ebe2;
  background: #fff;
}

.media-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.accommodation-under-media {
  display: none;
}

.under-location {
  font-weight: 700;
  color: #1d1d1f;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.under-details {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
  text-align: right;
}

.accommodation-media img,
.accommodation-media div {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.accommodation-body {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.accommodation-title-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
}

.accommodation-price-inline {
  display: inline-flex;
  flex: 0 0 auto;
}

.accommodation-title-row .accommodation-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.accommodation-reactions .reaction-pill-price {
  display: none;
}

.accommodation-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: #1f2023;
}

.accommodation-description {
  font-size: 0.92rem;
  color: #4a4a4f;
  line-height: 1.55;
  margin: 0;
}

.accommodation-read-more {
  font-size: 0.85rem;
  color: #0d6efd;
  font-weight: 600;
  text-decoration: none;
}

.accommodation-reactions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

@media (min-width: 992px) {
  .accommodation-reactions {
    display: none;
  }
}

.reaction-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  background: #fff9f3;
  font-size: 0.85rem;
  color: #222;
  border: 1px solid #ffe4c6;
  font-weight: 600;
}

.reaction-pill small {
  font-weight: 500;
  color: #8a8581;
}

/* Pagination Styles */
.pagination {
  margin-top: 30px;
  margin-bottom: 20px;
}

.page-link {
  border-radius: 8px;
  margin: 0 4px;
  padding: clamp(6px, 1.2vh + 0.3vw, 12px) clamp(10px, 2vw + 0.5vh, 18px);
  font-size: clamp(12px, 1.6vw + 0.4vh, 15px);
  font-weight: 600;
  transition: all 0.3s ease;
}

.page-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Smooth scroll for better UX */
html {
  scroll-behavior: smooth;
}

/* Loading animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.accommodation-card {
  animation: fadeIn 0.5s ease forwards;
}

.accommodation-card:nth-child(1) { animation-delay: 0.05s; }
.accommodation-card:nth-child(2) { animation-delay: 0.1s; }
.accommodation-card:nth-child(3) { animation-delay: 0.15s; }
.accommodation-card:nth-child(4) { animation-delay: 0.2s; }
</style>

<!-- University Selector Banner -->
<div class="university-selector-banner" onclick="toggleUniversityDropdown()">
  <div class="current-uni">{{ university.name|truncatechars:20 }}</div>
</div>

<div class="university-dropdown" id="universityDropdown">
  {% for uni in universities %}
    <a href="{% url 'students-university-properties' uni.id %}" class="university-dropdown-item {% if uni.id == university.id %}active{% endif %}">
      {{ uni.name }}
    </a>
  {% endfor %}
</div>

<!-- Fixed Search Bar -->
<div class="search-bar">
  <form method="get" id="searchForm">
    <div class="input-group">
      <input type="text" class="form-control search-input" name="q" placeholder="üîç Search by amenities (e.g., Wi-Fi) or price..." value="{{ request.GET.q }}">
      <button class="btn btn-primary search-btn" type="submit">Search</button>
    </div>
  </form>
</div>

<div class="content-wrapper">
  <div class="properties-grid">
    {% for p in page_obj.object_list %}
    <a href="{% url 'web-property-detail' p.id %}" class="accommodation-card">
      <div class="accommodation-header">
        <div class="accommodation-avatar">
          {% if p.images.first %}
            <img src="{{ p.images.first.image.url }}" alt="{{ p.title }} thumbnail">
          {% else %}
            <span>üè†</span>
          {% endif %}
        </div>
        <div class="accommodation-meta">
          <div class="accommodation-channel">
            {% if p.location %}
              {{ p.location }}
            {% elif p.city %}
              {{ p.city.name }}
            {% elif p.distance_km %}
              {{ p.distance_km }} km from campus
            {% else %}
              Around campus
            {% endif %}
          </div>
          <div class="accommodation-followers">
            {{ p.get_gender_display }} &middot; {{ p.get_sharing_display }}
          </div>
        </div>
        <button type="button" class="like-btn" data-property-id="{{ p.id }}" onclick="toggleLike(event, this, {{ p.id }})">‚ô°</button>
      </div>

      <!-- Single main image (same layout on all devices) -->
      <div class="accommodation-media">
        {% if p.images.first %}
          <img src="{{ p.images.first.image.url }}" alt="{{ p.title }}">
        {% else %}
          <div style="display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; color:#9c9589; font-weight:600;">
            <span style="font-size: clamp(40px, 8vw, 56px);">üì∑</span>
            <span>No imagery yet</span>
          </div>
        {% endif %}
      </div>

      <!-- Desktop image scroller removed (match mobile card design) -->
      <div class="accommodation-media accommodation-media-desktop d-none">
        {% if p.images.all %}
          <div class="media-scroll" aria-label="Images for {{ p.title }}">
            {% for img in p.images.all %}
              <div class="media-item">
                <img src="{{ img.image.url }}" alt="{{ p.title }} image {{ forloop.counter }}">
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; color:#9c9589; font-weight:600; height: 100%;">
            <span style="font-size: 56px;">üì∑</span>
            <span>No imagery yet</span>
          </div>
        {% endif %}
      </div>

      <div class="accommodation-under-media d-none" aria-label="Property summary"></div>

      <div class="accommodation-body">
        <div class="accommodation-title-row">
          <div class="accommodation-title">{{ p.title }}</div>
          <span class="reaction-pill reaction-pill-price accommodation-price-inline">üî•
            {% if p.overnight and request.GET.overnight %}
              ${{ p.nightly_price|default_if_none:"N/A" }} <small>/night</small>
            {% else %}
              ${{ p.price_per_month|default_if_none:"N/A" }} <small>/month</small>
            {% endif %}
          </span>
        </div>
        {% if p.description %}
        <p class="accommodation-description">{{ p.description|truncatechars:110 }}</p>
        {% endif %}
        <span class="accommodation-read-more">Read more</span>
      </div>

      <div class="accommodation-reactions">
        <span class="reaction-pill reaction-pill-price">üî•
          {% if p.overnight and request.GET.overnight %}
            ${{ p.nightly_price|default_if_none:"N/A" }} <small>/night</small>
          {% else %}
            ${{ p.price_per_month|default_if_none:"N/A" }} <small>/month</small>
          {% endif %}
        </span>
        <span class="reaction-pill">üëç {{ p.get_sharing_display }}</span>
            <span class="reaction-pill">‚ù§Ô∏è {{ p.max_occupancy|default_if_none:"‚Äî" }} <small>max</small></span>
      </div>
    </a>
    {% empty %}
    <div style="grid-column: 1 / -1; text-align: center; padding: 80px 20px; color: #717171;">
      <div style="font-size: clamp(48px, 8vw, 72px); margin-bottom: 24px; opacity: 0.5;">üèòÔ∏è</div>
      <div style="font-size: clamp(18px, 2.5vw, 24px); font-weight: 600; margin-bottom: 12px;">No properties found</div>
      <div style="font-size: clamp(13px, 2vw, 16px); color: #999;">Try adjusting your filters or search terms</div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        {% with qp=request.GET.urlencode %}
        <li class="page-item"><a class="page-link" href="?{% if qp %}{{ qp }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endwith %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        {% with qp=request.GET.urlencode %}
        <li class="page-item"><a class="page-link" href="?{% if qp %}{{ qp }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a></li>
        {% endwith %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Fixed Bottom Filter Panel -->
<div class="filter-panel">
  <button class="filter-btn active" onclick="filterProperties('all')">All</button>
  <button class="filter-btn" onclick="filterProperties('two')">2 Sharing</button>
  <button class="filter-btn" onclick="filterProperties('single')">Single Room</button>
  <button class="filter-btn" onclick="filterProperties('boys')">Boys Only</button>
  <button class="filter-btn" onclick="filterProperties('girls')">Girls Only</button>
  <button class="filter-btn" onclick="filterProperties('mixed')">Mixed</button>
  <button class="filter-btn" onclick="filterProperties('overnight')">Overnight</button>
</div>

<script>
function filterProperties(filter) {
  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Build URL with filter
  const url = new URL(window.location.href);
  url.searchParams.delete('gender');
  url.searchParams.delete('sharing');
  url.searchParams.delete('overnight');
  
  if (filter !== 'all') {
    if (filter === 'boys') url.searchParams.set('gender', 'boys');
    else if (filter === 'girls') url.searchParams.set('gender', 'girls');
    else if (filter === 'mixed') url.searchParams.set('gender', 'mixed');
    else if (filter === 'single') url.searchParams.set('sharing', 'single');
    else if (filter === 'two') url.searchParams.set('sharing', 'two');
    else if (filter === 'overnight') url.searchParams.set('overnight', '1');
  }
  
  window.location.href = url.toString();
}

// Set active filter based on URL params
window.addEventListener('DOMContentLoaded', function() {
  const params = new URLSearchParams(window.location.search);
  const gender = params.get('gender');
  const sharing = params.get('sharing');
  const overnight = params.get('overnight');
  
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  
  if (gender === 'boys') document.querySelector('[onclick*="boys"]').classList.add('active');
  else if (gender === 'girls') document.querySelector('[onclick*="girls"]').classList.add('active');
  else if (gender === 'mixed') document.querySelector('[onclick*="mixed"]').classList.add('active');
  else if (sharing === 'single') document.querySelector('[onclick*="single"]').classList.add('active');
  else if (sharing === 'two') document.querySelector('[onclick*="two"]').classList.add('active');
  else if (overnight === '1') document.querySelector('[onclick*="overnight"]').classList.add('active');
  else document.querySelector('[onclick*="all"]').classList.add('active');
});

// University selector dropdown
function toggleUniversityDropdown() {
  const dropdown = document.getElementById('universityDropdown');
  dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const banner = document.querySelector('.university-selector-banner');
  const dropdown = document.getElementById('universityDropdown');
  
  if (!banner.contains(event.target) && !dropdown.contains(event.target)) {
    dropdown.classList.remove('show');
  }
});

// Like button functionality
function toggleLike(ev, btn, propertyId) {
  ev.preventDefault();
  ev.stopPropagation();

  {% if request.user.is_authenticated %}
  fetch('/api/properties/' + propertyId + '/toggle-like/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken') || '',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ action: 'toggle' })
  })
    .then(response => response.json())
    .then(data => {
      if (typeof data.liked !== 'undefined') {
        btn.classList.toggle('liked', data.liked);
      } else {
        btn.classList.toggle('liked');
      }
    })
    .catch(() => btn.classList.toggle('liked'));
  {% else %}
  const liked = JSON.parse(localStorage.getItem('liked_properties') || '[]');
  const index = liked.indexOf(propertyId);
  if (index > -1) {
    liked.splice(index, 1);
    btn.classList.remove('liked');
  } else {
    liked.push(propertyId);
    btn.classList.add('liked');
  }
  localStorage.setItem('liked_properties', JSON.stringify(liked));
  {% endif %}
}

{% if not request.user.is_authenticated %}
document.addEventListener('DOMContentLoaded', function() {
  const liked = JSON.parse(localStorage.getItem('liked_properties') || '[]');
  liked.forEach(function(id) {
    const target = document.querySelector('.like-btn[data-property-id="' + id + '"]');
    if (target) {
      target.classList.add('liked');
    }
  });
});
{% endif %}
</script>
{% endblock %}
